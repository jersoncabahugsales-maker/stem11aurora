<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>General Mathematics — Grade Viewer</title>
  <style>
    :root{
      --bg:#f7fbff;
      --card:#ffffff;
      --accent:#e6f4ff;
      --blue:#1e90ff;
      --muted:#52606a;
      --radius:14px;
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#eef7ff);}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px;}
    .card{background:var(--card);border-radius:16px;box-shadow:0 12px 30px rgba(20,40,80,0.06);max-width:980px;width:100%;padding:26px;display:flex;gap:20px;align-items:stretch;}
    .left{flex:1;display:flex;flex-direction:column;gap:14px;justify-content:center;padding:8px;}
    .right{flex:1.05;background:linear-gradient(180deg,#fff,var(--accent));border-radius:12px;padding:18px;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;}
    h1{margin:0;font-size:20px;color:#042f4a}
    h2{margin:0;font-size:16px;color:#042f4a}
    p{margin:0;color:var(--muted)}
    .big-cta{background:linear-gradient(90deg,var(--blue),#3fa9ff);color:white;padding:12px 18px;border-radius:10px;border:none;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(30,144,255,0.18);}
    .input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(10,30,60,0.06);font-size:14px}
    .sections{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .section{background:white;border-radius:12px;padding:12px 16px;min-width:140px;text-align:center;cursor:pointer;box-shadow:0 8px 20px rgba(40,80,120,0.04);border:1px solid rgba(10,30,60,0.04);font-weight:600}
    .section:hover{transform:translateY(-6px);transition:all .18s}
    .muted{color:var(--muted);font-size:13px}
    .topbar{display:flex;justify-content:space-between;align-items:center;width:100%}
    .btn-ghost{background:transparent;border:1px solid rgba(10,30,60,0.06);padding:8px 12px;border-radius:9px;cursor:pointer}
    .db-table{width:100%;border-collapse:collapse}
    .db-table th,.db-table td{padding:8px;border-bottom:1px solid rgba(10,30,60,0.04);text-align:left;font-size:13px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .notice{background:#eef9ff;padding:10px;border-radius:10px;color:#05507a}
    .footer{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
    .hidden{display:none}
    .center{display:flex;align-items:center;justify-content:center}
    .editable{background:transparent;border:none;padding:6px;font-size:13px;width:100%}
    .table-wrap{max-height:420px;overflow:auto;border-radius:8px}
    .hero{cursor:pointer;padding:18px;border-radius:12px;background:linear-gradient(90deg,#ffffff,#f1fbff);border:1px solid rgba(200,230,255,0.6);display:flex;gap:14px;align-items:center}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,#dff2ff,#bfe6ff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#034b78;font-size:22px}
    @media (max-width:860px){
      .card{flex-direction:column;padding:18px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="left" id="landing">
        <div class="hero" id="heroStart">
          <div class="logo">GM</div>
          <div style="text-align:left">
            <h1 id="greetingTitle">Welcome to General Mathematics Class</h1>
            <p class="muted" style="margin-top:6px">Subject Teacher: <strong>Jerson C. Sales</strong></p>
          </div>
        </div>

        <div style="margin-top:18px">
          <p class="small muted">Enter the class access code to continue to the grade viewer.</p>
          <div style="margin-top:8px;display:flex;gap:8px">
            <input id="accessCode" class="input" placeholder="Enter class code" autocomplete="off" />
            <button class="big-cta" id="enterCodeBtn">Enter</button>
          </div>
          <p class="small muted" style="margin-top:8px">(The passcode is checked behind the scenes.)</p>
        </div>

        <div style="margin-top:20px">
          <div class="notice">
            Students will only see their personal grade after selecting section and entering LRN.
          </div>
        </div>

        <div style="margin-top:20px" class="center">
          <button class="btn-ghost" id="showPreview">Preview interface (no login)</button>
        </div>

        <div class="footer">Client-side demo. For stronger security use a backend.</div>
      </div>

      <div class="right hidden" id="portal">
        <div class="topbar" style="width:100%">
          <div>
            <h2>General Mathematics Grade Viewing Database</h2>
            <p class="muted">Select your section to view your personal grade</p>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-ghost" id="logoutBtn">Log out</button>
            <button class="btn-ghost" id="adminToggle">Teacher / Admin</button>
          </div>
        </div>

        <div style="width:100%;margin-top:8px" id="sectionsArea">
          <div class="sections">
            <div class="section" data-section="Aurora">Aurora</div>
            <div class="section" data-section="Ember">Ember</div>
            <div class="section" data-section="Oasis">Oasis</div>
            <div class="section" data-section="Solstice">Solstice</div>
            <div class="section" data-section="Meadow">Meadow</div>
          </div>
        </div>

        <div id="lrnPrompt" class="hidden" style="margin-top:12px;width:100%">
          <div style="display:flex;gap:8px;align-items:center">
            <input id="lrnInput" class="input" placeholder="Enter your LRN (Learner's Reference Number)" autocomplete="off" />
            <button class="big-cta" id="viewGradeBtn">View Grade</button>
          </div>
          <p class="small muted" style="margin-top:6px">Only your grade will be shown.</p>
        </div>

        <div id="result" class="hidden" style="margin-top:12px;width:100%">
          <div style="background:white;padding:16px;border-radius:12px;width:100%;text-align:center">
            <div id="resultName" style="font-weight:700;font-size:16px;color:#053b57"></div>
            <div id="resultGrade" style="font-size:34px;font-weight:800;margin-top:6px;color:#0b5aa6"></div>
            <div id="resultRemarks" style="margin-top:10px;color:var(--muted);font-weight:600"></div>
          </div>
        </div>

        <!-- Admin area -->
        <div id="adminArea" class="hidden" style="width:100%;margin-top:14px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Admin mode</strong>
              <p class="small muted">Edit LRNs, names, and grades. Changes persist in browser storage and can be exported/imported as CSV.</p>
            </div>
            <div class="controls">
              <button class="btn-ghost" id="downloadCsv">Download CSV</button>
              <label class="btn-ghost" id="uploadCsvLabel" style="cursor:pointer">Upload CSV</label>
              <input type="file" id="uploadCsv" accept=".csv" style="display:none" />
              <button class="btn-ghost" id="saveDbBtn">Save changes</button>
            </div>
          </div>

          <div style="margin-top:10px" class="table-wrap">
            <table class="db-table" id="dbTable">
              <thead>
                <tr>
                  <th>Section</th>
                  <th>LRN</th>
                  <th>Student Name</th>
                  <th>Grade</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="dbBody"></tbody>
            </table>
          </div>
          <div style="margin-top:8px" class="small muted">Tip: edit cells, then press "Save changes" to persist to this browser's storage. Export CSV as backup.</div>
        </div>

        <div class="footer" style="margin-top:14px">If you are the teacher: use admin mode to maintain the database.</div>
      </div>
    </div>
  </div>

<script>
/*
  Full client-side Grade Viewer
  - Class code: GenMath2025 (checked client-side, encoded)
  - Admin code: 675915 (checked client-side, encoded)
  - DB seeded from user-provided lists; editable by admin; stored in localStorage when saved.
  - Shows pass/fail messages per requirements.
*/

/* helpers */
const $ = id => document.getElementById(id);
const qs = s => document.querySelector(s);
const qsa = s => document.querySelectorAll(s);
function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }

/* small/base64 obfuscation so passcodes aren't visible in interface source at first glance */
const encode = s => btoa(s);
const decode = s => atob(s);
const CLASS_CODE_B64 = encode('GenMath2025');
const ADMIN_CODE_B64 = encode('675915');

/* Storage key */
const STORAGE_KEY = 'gm_grade_db_v1';

/* Seed DB (copied directly from your data). Each object: { section, lrn, name, grade } */
const seedDB = [
  /* Aurora */
  {section:'Aurora', lrn:'113797140007', name:'Alutaya, MJ O.', grade:88},
  {section:'Aurora', lrn:'113604140025', name:'Aparente, Austin Jolf S.', grade:85},
  {section:'Aurora', lrn:'113604140026', name:'Arizobal, Robert Jules O.', grade:91},
  {section:'Aurora', lrn:'113606150076', name:'Atacador, Rey Kenneth C.', grade:91},
  {section:'Aurora', lrn:'113606130113', name:'Capellan, Kian Carl N.', grade:83},
  {section:'Aurora', lrn:'113602140018', name:'Delara, Jhonpyu A.', grade:92},
  {section:'Aurora', lrn:'113602140008', name:'Delara, Joeren Joules O.', grade:92},
  {section:'Aurora', lrn:'113606150001', name:'Dilao, Mark Lawrence P.', grade:94},
  {section:'Aurora', lrn:'113606140061', name:'Gabelo, Yeshuah Ashliegh B.', grade:87},
  {section:'Aurora', lrn:'113606150116', name:'Gamba, Renzell Wen G.', grade:86},
  {section:'Aurora', lrn:'113951140031', name:'Manlapaz, Mark Laurence B.', grade:88},
  {section:'Aurora', lrn:'113606140170', name:'Paraguya, Josua E.', grade:85},
  {section:'Aurora', lrn:'113605140018', name:'Piodos, John Errol M.', grade:91},
  {section:'Aurora', lrn:'113612140017', name:'Raymundo, Kyle Nathan M.', grade:86},
  {section:'Aurora', lrn:'113597140007', name:'Resma, Lenard B.', grade:94},
  {section:'Aurora', lrn:'113599140008', name:'Retuerto, Remark Fel R.', grade:95},
  {section:'Aurora', lrn:'113606140109', name:'Valle, Jahn Aj Vhin T.', grade:95},
  {section:'Aurora', lrn:'113606140130', name:'Almero, Mikaela Mildred D.', grade:92},
  {section:'Aurora', lrn:'113606140132', name:'Arizala, Rain A.', grade:89},
  {section:'Aurora', lrn:'113786140015', name:'Atega, Dianne Ashly M.', grade:83},
  {section:'Aurora', lrn:'113608140025', name:'Cabrera, Wenchie P.', grade:94},
  {section:'Aurora', lrn:'113606140142', name:'Cervantes, Nica A.', grade:90},
  {section:'Aurora', lrn:'113589140014', name:'Edem, Jeramie M.', grade:83},
  {section:'Aurora', lrn:'113606140173', name:'Huelva, Jelianne S.', grade:92},
  {section:'Aurora', lrn:'113597140060', name:'Ibañez, Carmela O.', grade:89},
  {section:'Aurora', lrn:'113597140060', name:'Jores, Cristel B.', grade:90},
  {section:'Aurora', lrn:'113597140026', name:'Malunes, Fricel Blaze A.', grade:94},
  {section:'Aurora', lrn:'113599140030', name:'Pelayo, Trecia Faith C.', grade:84},
  {section:'Aurora', lrn:'402104150245', name:'Peteros, Lhola Belle E.', grade:92},
  {section:'Aurora', lrn:'113677130163', name:'Salazar, Shane A.', grade:91},
  {section:'Aurora', lrn:'113609140024', name:'Tagbacaola, Irene A.', grade:96},
  {section:'Aurora', lrn:'113782140023', name:'Tamayo, Mary Antoniette A.', grade:97},

  /* Ember */
  {section:'Ember', lrn:'113597140014', name:'AFABLE,CLARENS ANTIPOLO', grade:74},
  {section:'Ember', lrn:'113610140002', name:'ALFORTE,RANNEL JOHN BALDEO', grade:78},
  {section:'Ember', lrn:'113606140068', name:'ATABAY,JURODS BASAS', grade:75},
  {section:'Ember', lrn:'113606140041', name:'CAGATIN,MARC JAY MARFIL', grade:74},
  {section:'Ember', lrn:'113606140051', name:'CAPELLAN,JAMES ROLLY TOLENTINO', grade:77},
  {section:'Ember', lrn:'113606140046', name:'CASTOR,KENNY RICH SALONDAGA', grade:82},
  {section:'Ember', lrn:'120868140083', name:'GERVACIO,CZECH NAZARINE DINGAL', grade:80},
  {section:'Ember', lrn:'113951140024', name:'GIMANG,BABY NIÑO VAFLOR', grade:94},
  {section:'Ember', lrn:'113943140021', name:'GUIOGUIO,WINNARD KENT DALANON', grade:88},
  {section:'Ember', lrn:'113604140035', name:'LETADA,R-JAY VILLAMOR', grade:75},
  {section:'Ember', lrn:'113712140015', name:'TAMAYO,RENZ IVAN FUENTES', grade:75},
  {section:'Ember', lrn:'113606140183', name:'VILLAMIN,JAMES JAHRED GUIRIBA', grade:84},
  {section:'Ember', lrn:'113606140185', name:'VISDA,MATTHEW JOSH BISNAR', grade:78},
  {section:'Ember', lrn:'113606140113', name:'ABAÑO,JESSA MAE ALICANTE', grade:75},
  {section:'Ember', lrn:'113612120033', name:'AFABLE,NOVIE EMPAS', grade:78},
  {section:'Ember', lrn:'113951140037', name:'ALORAN,MARIA PRINCESS AMARO', grade:79},
  {section:'Ember', lrn:'113606140124', name:'ARROYO,KIMBERLY MOTITA', grade:79},
  {section:'Ember', lrn:'113606140126', name:'ATABAY,JEAN ESCARO', grade:86},
  {section:'Ember', lrn:'113606140128', name:'ATABAY,MARY CLAIRE GADIANA', grade:84},
  {section:'Ember', lrn:'113606150115', name:'CAJEGAS,BENNIE MARIE CAPELLAN', grade:81},
  {section:'Ember', lrn:'136836140494', name:'CAPELLAN,PRESCILLA ENATE', grade:80},
  {section:'Ember', lrn:'113606150071', name:'CARILLO,IRISH MITRA', grade:81},
  {section:'Ember', lrn:'113610140012', name:'CLORES,JOJIELYN ARAGON', grade:82},
  {section:'Ember', lrn:'113786140045', name:'DELAVIN,CHENKIE CASIO', grade:83},
  {section:'Ember', lrn:'113606140144', name:'DERLA,PRINCESS MAE SORIANO', grade:85},
  {section:'Ember', lrn:'103871140036', name:'ESCALA,SCARLETTE SORIANO', grade:88},
  {section:'Ember', lrn:'113605140032', name:'GARCIA,ANALYN TAMAYO', grade:90},
  {section:'Ember', lrn:'113610140016', name:'LOZADA,NECEL JOY BULALAQUE', grade:91},
  {section:'Ember', lrn:'113604140052', name:'NAGA,JAMIE LOREN TINAY', grade:85},
  {section:'Ember', lrn:'113606140164', name:'ORIAS,TRISHA JANE NUÑEZ', grade:81},
  {section:'Ember', lrn:'113603140010', name:'PABILANDO,JHOANNA VILLANTES', grade:89},
  {section:'Ember', lrn:'113606140160', name:'PEÑARANDA,JAN MONICQUE ESPARRAGO', grade:88},
  {section:'Ember', lrn:'113606140178', name:'ROBISO,ANDREA ATENDIDO', grade:75},
  {section:'Ember', lrn:'113605140039', name:'SANCHEZ,DIANNE PATRICIA BERGADO', grade:93},
  {section:'Ember', lrn:'113504140033', name:'TORRENUEVA,PRINCESS GEMINO', grade:85},
  {section:'Ember', lrn:'113606140161', name:'VALLERAS,ROSELYN JERUSALEM', grade:79},

  /* Oasis */
  {section:'Oasis', lrn:'113606140050', name:'Arimbuyutan, Nhel John Elyson A.', grade:76},
  {section:'Oasis', lrn:'113602140005', name:'Belarmino, Mark Dm H.', grade:83},
  {section:'Oasis', lrn:'113606140060', name:'Canete, Jolit Z.', grade:78},
  {section:'Oasis', lrn:'113597140071', name:'Diaz, Jethro L.', grade:90},
  {section:'Oasis', lrn:'113613140004', name:'Ecita, Lorince D.', grade:76},
  {section:'Oasis', lrn:'113613140005', name:'Igloso, Jerry Jr. C.', grade:80},
  {section:'Oasis', lrn:'113617140031', name:'Mahayag, Kyle', grade:85},
  {section:'Oasis', lrn:'113604140036', name:'Mahinay, Romel C.', grade:81},
  {section:'Oasis', lrn:'113606140074', name:'Manlangit, Lester C.', grade:88},
  {section:'Oasis', lrn:'113615140011', name:'Minggoy, John Mark V.', grade:75},
  {section:'Oasis', lrn:'113605130037', name:'Ramirez, Jielo A.', grade:77},
  {section:'Oasis', lrn:'113604140042', name:'Serafin, Reynald P.', grade:70},
  {section:'Oasis', lrn:'136838140101', name:'Ubac, Michael John M.', grade:79},
  {section:'Oasis', lrn:'113606150124', name:'Alforque, Anniver C.', grade:75},
  {section:'Oasis', lrn:'113615140014', name:'Aplacador, Arnie', grade:77},
  {section:'Oasis', lrn:'113614140016', name:'Apues, Marjorie A.', grade:75},
  {section:'Oasis', lrn:'113606140129', name:'Arizobal, Jenny P.', grade:75},
  {section:'Oasis', lrn:'113606140088', name:'Atizado, Princess Odesa P.', grade:81},
  {section:'Oasis', lrn:'113951140053', name:'Bandol, Loida A.', grade:77},
  {section:'Oasis', lrn:'110282140176', name:'Baring, Kristine M.', grade:81},
  {section:'Oasis', lrn:'113599140015', name:'Baring, Lanilyn A.', grade:90},
  {section:'Oasis', lrn:'113606140143', name:'Bayagosa, Esiel V.', grade:76},
  {section:'Oasis', lrn:'113606140139', name:'Caones, Cynde M.', grade:82},
  {section:'Oasis', lrn:'113597140019', name:'Catarinin, Victoria M.', grade:81},
  {section:'Oasis', lrn:'113612140024', name:'Etang, Kristine Rein Lara', grade:80},
  {section:'Oasis', lrn:'113617140002', name:'Francisco, Emmalyn E.', grade:81},
  {section:'Oasis', lrn:'113613140019', name:'Jubay, Jeann M.', grade:74},
  {section:'Oasis', lrn:'123456789012', name:'Lerit, Sassy Liane A.', grade:70},
  {section:'Oasis', lrn:'113597140053', name:'Luzong C. Nancy', grade:86},
  {section:'Oasis', lrn:'113786140055', name:'Mahinay, Gella', grade:77},
  {section:'Oasis', lrn:'113597120160', name:'Moreno, Jenny A.', grade:75},
  {section:'Oasis', lrn:'113606140177', name:'Natural, Erika Joy P.', grade:79},
  {section:'Oasis', lrn:'113606140114', name:'Noda, Glyza B.', grade:75},
  {section:'Oasis', lrn:'113604140050', name:'Orbes, Annjean B.', grade:78},
  {section:'Oasis', lrn:'113613140016', name:'Paghunasan, Shery-Ann T.', grade:83},
  {section:'Oasis', lrn:'113606140115', name:'Paran, Ronalyn D.', grade:81},
  {section:'Oasis', lrn:'113951140046', name:'Pascua, Danica A.', grade:78},
  {section:'Oasis', lrn:'113951140086', name:'Presilda, Janna Shane R.', grade:78},
  {section:'Oasis', lrn:'113606140116', name:'Ramirez, Jendy V.', grade:80},
  {section:'Oasis', lrn:'113597140027', name:'Rupa, Clavel O.', grade:78},

  /* Solstice */
  {section:'Solstice', lrn:'113612140003', name:'AVILA,GIAN JOSH RAYMUNDO', grade:76},
  {section:'Solstice', lrn:'113605130028', name:'BELEN,JACKPHILLIP MENDERO', grade:73},
  {section:'Solstice', lrn:'110108140048', name:'BERRES,GEIAN CARLO RONDA', grade:75},
  {section:'Solstice', lrn:'136524150592', name:'CABRALES,AL FRANCIS AFABLE', grade:78},
  {section:'Solstice', lrn:'113606140044', name:'CARMEN,ERNESTO JR BERDIN', grade:73},
  {section:'Solstice', lrn:'113606130133', name:'COSTE,IGNACIO III ABAYON', grade:73},
  {section:'Solstice', lrn:'113606110055', name:'DEL MUNDO,JUSTINE PABATANG', grade:74},
  {section:'Solstice', lrn:'109156150106', name:'DELA CRUZ,JOHN KYLE -', grade:76},
  {section:'Solstice', lrn:'113602130016', name:'DOCUSIN,GIAN SOCITO', grade:78},
  {section:'Solstice', lrn:'113954130030', name:'ERENIA,KIM OCHEA', grade:73},
  {section:'Solstice', lrn:'113597140011', name:'FLORES,DAVE RABUYA', grade:75},
  {section:'Solstice', lrn:'113604120065', name:'LIBAY,JOSHUA VILLAMAR', grade:77},
  {section:'Solstice', lrn:'113602140012', name:'LUCENESIO,MARK JUSTIN ETAOC', grade:73},
  {section:'Solstice', lrn:'113613130008', name:'LUGANA,JADE IGLOSO', grade:70},
  {section:'Solstice', lrn:'113606140099', name:'LUZONG,BRENT KEVIN ARIZOBAL', grade:80},
  {section:'Solstice', lrn:'113608110042', name:'MALANA,GEHARD ADIGUE', grade:81},
  {section:'Solstice', lrn:'113614140009', name:'MONTECALVO,JOJIE AREGLADO', grade:75},
  {section:'Solstice', lrn:'113612140020', name:'TAMAYO,JOHN LESTER BELARMINO', grade:75},
  {section:'Solstice', lrn:'104753140051', name:'TOROY,DAVE ESPEJON', grade:76},
  {section:'Solstice', lrn:'136477140516', name:'TRINIDAD,JOHN WAYNE LUTCHE', grade:73},
  {section:'Solstice', lrn:'113603140006', name:'TUMANGAN,NHOAH BUJAWE', grade:75},
  {section:'Solstice', lrn:'113606140119', name:'ALIÑO,JEAN BENARO', grade:73},
  {section:'Solstice', lrn:'113597140076', name:'ARCUENO,AMANDA ANDRINO', grade:84},
  {section:'Solstice', lrn:'113606140123', name:'ARMA,ROCHELLE COSTE', grade:74},
  {section:'Solstice', lrn:'113612140023', name:'BARRUGA,RICHEL SOQUESO', grade:73},
  {section:'Solstice', lrn:'113613140012', name:'BRUSAS,JESSEL CAPALAR', grade:81},
  {section:'Solstice', lrn:'113608120068', name:'CANTORIA,JIZEL AMARO', grade:73},
  {section:'Solstice', lrn:'113613140013', name:'CAPALAR,RICHELYN CABAIS', grade:80},
  {section:'Solstice', lrn:'113602140021', name:'CARASICAS,SUSAN ANABE', grade:74},
  {section:'Solstice', lrn:'113606140093', name:'COLIBAO,ALEYAH ARCUENO', grade:76},
  {section:'Solstice', lrn:'113610140013', name:'ESCOTE,ROMA MAE MONCADA', grade:73},
  {section:'Solstice', lrn:'113604140046', name:'FRANCISCO,ANIELYN PALANAS', grade:76},
  {section:'Solstice', lrn:'113605140033', name:'GARCIA,SHIELA MAE BARILE', grade:74},
  {section:'Solstice', lrn:'113606140150', name:'GESTIADA,JULIA JANE IGNACIO', grade:75},
  {section:'Solstice', lrn:'113606130227', name:'MADERA,JERECA VERDIDA', grade:73},
  {section:'Solstice', lrn:'113951130094', name:'RICARTE,SHEILA MAE ESQUILONA', grade:75},
  {section:'Solstice', lrn:'113612140027', name:'ROMBAIZ,ROSALYN ADIGUE', grade:73},
  {section:'Solstice', lrn:'113617140028', name:'SALUNDAGA,JOSEL ALMOGUERA', grade:75},
  {section:'Solstice', lrn:'113597140065', name:'SANCHEZ,JESEL ARCUENO', grade:73},
  {section:'Solstice', lrn:'113612140028', name:'TAMAYO,PRINCESS HANNAH YLARAN', grade:75},

  /* Meadow */
  {section:'Meadow', lrn:'113610130009', name:'ARRANGUEZ,MARK LEO ALFORTE', grade:73},
  {section:'Meadow', lrn:'113956130022', name:'BOGABIL,ALDIN LUMALANG', grade:76},
  {section:'Meadow', lrn:'113602140017', name:'CABAGUE,MIGUEL VIDA', grade:75},
  {section:'Meadow', lrn:'113604140006', name:'CABINTOY,JEROME CASIDSID', grade:73},
  {section:'Meadow', lrn:'113602120010', name:'CARASICAS,JEVAN ANABE', grade:76},
  {section:'Meadow', lrn:'113605140007', name:'DELA CRUZ,JHONNY FRANCISCO', grade:75},
  {section:'Meadow', lrn:'113604140007', name:'FLORES,JEM VASQUEZ', grade:77},
  {section:'Meadow', lrn:'113605140012', name:'MANANGAT,ERIC MENEL', grade:76},
  {section:'Meadow', lrn:'113604140038', name:'MITRA,CYRIL JOHN ESTRADA', grade:73},
  {section:'Meadow', lrn:'113610140006', name:'MONCADA,RON MART ESCOTE', grade:76},
  {section:'Meadow', lrn:'113606140169', name:'PARAGUYA,GERALD ESCARAN', grade:74},
  {section:'Meadow', lrn:'113605140017', name:'PINOTE,JAMES ABLAS', grade:76},
  {section:'Meadow', lrn:'113606140181', name:'RAMIREZ,RONIE MARK MENDOZA', grade:75},
  {section:'Meadow', lrn:'113606140182', name:'TANA,FRANCE HERMOSA', grade:73},
  {section:'Meadow', lrn:'113613130013', name:'URBANO,JOHN CARLO CAPELLAN', grade:90},
  {section:'Meadow', lrn:'113612110001', name:'ABAD,JUVYMAE BARRUGA', grade:''},
  {section:'Meadow', lrn:'113610140008', name:'ADORNA,CHARISA REBUJAS', grade:75},
  {section:'Meadow', lrn:'113610140009', name:'ALFORTE,MERYL JOY CAÑELAS', grade:75},
  {section:'Meadow', lrn:'113597130044', name:'ARCUENO,JENELYN PRESILDA', grade:73},
  {section:'Meadow', lrn:'113605140023', name:'ATIBAGOS,CRISHELLE FLORES', grade:74},
  {section:'Meadow', lrn:'113610140010', name:'BADIANA,MARIAN ARCON', grade:73},
  {section:'Meadow', lrn:'113613130017', name:'BILARMINO,RAYCEL LATAGAN', grade:74},
  {section:'Meadow', lrn:'113610140011', name:'BOGNOT,KIMBERLY ARAGON', grade:73},
  {section:'Meadow', lrn:'113596120049', name:'CAADLAWON,BELIZA BOHOL', grade:75},
  {section:'Meadow', lrn:'113604140012', name:'CARIÑO,DANICE ARQUIO', grade:75},
  {section:'Meadow', lrn:'113606140147', name:'CLEMENTE,MAURENE NICDAO', grade:77},
  {section:'Meadow', lrn:'165510141544', name:'COLLADO,HANNAH OSABEL', grade:72},
  {section:'Meadow', lrn:'120741140026', name:'CONTREDAS,CRISTINE LABATETE', grade:74},
  {section:'Meadow', lrn:'113606140094', name:'COSTE,GECEL TABOR', grade:74},
  {section:'Meadow', lrn:'113608140014', name:'CUIZON,JUNALYN ABELINDE', grade:75},
  {section:'Meadow', lrn:'113942140018', name:'DAO,LEIAN CARILLO', grade:75},
  {section:'Meadow', lrn:'113612130037', name:'DELA PEÑA,CHARLENE GAVIOLA', grade:77},
  {section:'Meadow', lrn:'113606140096', name:'DELOS SANTOS,LUJIL BELO', grade:75},
  {section:'Meadow', lrn:'113597140021', name:'ECITA,CHARMAE CAÑELAS', grade:77},
  {section:'Meadow', lrn:'113597140077', name:'LUCENESIO,ANGELICA VEPINOSA', grade:76},
  {section:'Meadow', lrn:'113606140175', name:'MAGLASANG,DANIELA COLUMNA', grade:81},
  {section:'Meadow', lrn:'113617130046', name:'MATERDAN,JESALYN TAMBOBOY', grade:72},
  {section:'Meadow', lrn:'113606140118', name:'RAYMUNDO,RHEA BANDOL', grade:76},
  {section:'Meadow', lrn:'113605140038', name:'SAMPAGA,JESSICA VILLAR', grade:74}
];

/* Load DB from localStorage or seed */
function loadDB(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) return parsed;
    }
  }catch(e){ console.warn('load error', e); }
  // deep copy seed
  return JSON.parse(JSON.stringify(seedDB));
}
let DB = loadDB();

/* UI elements */
const accessCode = $('accessCode');
const enterCodeBtn = $('enterCodeBtn');
const landing = $('landing');
const portal = $('portal');
const sections = document.querySelectorAll('.section');
const lrnPrompt = $('lrnPrompt');
const lrnInput = $('lrnInput');
const viewGradeBtn = $('viewGradeBtn');
const result = $('result');
const resultName = $('resultName');
const resultGrade = $('resultGrade');
const resultRemarks = $('resultRemarks');
const logoutBtn = $('logoutBtn');
const adminToggle = $('adminToggle');
const adminArea = $('adminArea');
const dbBody = $('dbBody');
const saveDbBtn = $('saveDbBtn');
const downloadCsv = $('downloadCsv');
const uploadCsv = $('uploadCsv');
const uploadCsvLabel = $('uploadCsvLabel');
const showPreview = $('showPreview');
const heroStart = $('heroStart');

let loggedIn = false;
let currentSection = null;

/* Check codes (decoded) */
function validClassCode(v){ return String(v).trim() === decode(CLASS_CODE_B64); }
function validAdminCode(v){ return String(v).trim() === decode(ADMIN_CODE_B64); }

/* Landing hero click should show greeting (already visible) — keep as small friendly prompt */
heroStart.addEventListener('click', ()=>{
  alert('Welcome to General Mathematics Class\\nSubject Teacher: Jerson C. Sales');
});

/* Preview button */
showPreview.addEventListener('click', ()=>{
  alert('Preview only — to view grades enter class access code.');
});

/* Enter class code */
enterCodeBtn.addEventListener('click', ()=>{
  const v = accessCode.value.trim();
  if(!v){ alert('Enter class access code.'); return; }
  if(validClassCode(v)){
    accessCode.value = '';
    loggedIn = true;
    hide(landing);
    show(portal);
    hide(adminArea);
    hide(result);
    hide(lrnPrompt);
    currentSection = null;
  } else {
    alert('Incorrect code. Please try again.');
  }
});

/* Section selection */
sections.forEach(s => s.addEventListener('click', (e)=>{
  if(!loggedIn){ alert('Please enter class access code first.'); return; }
  currentSection = e.currentTarget.dataset.section;
  show(lrnPrompt);
  hide(result);
  lrnInput.value = '';
  lrnInput.focus();
}));

/* View grade */
viewGradeBtn.addEventListener('click', attemptView);
lrnInput.addEventListener('keypress', (e)=>{ if(e.key === 'Enter') attemptView(); });

function attemptView(){
  const lrn = String(lrnInput.value||'').trim();
  if(!currentSection){ alert('Select your section first.'); return; }
  if(!lrn){ alert('Enter your LRN.'); return; }
  const matches = DB.filter(r => r.section === currentSection && String(r.lrn) === String(lrn));
  if(matches.length === 0){
    resultName.textContent = 'No record found';
    resultGrade.textContent = '—';
    resultRemarks.textContent = 'Please check your section and LRN.';
    show(result);
    return;
  }
  // show first match only
  const rec = matches[0];
  resultName.textContent = rec.name || 'No name';
  resultGrade.textContent = (rec.grade === '' || rec.grade === null) ? 'No grade yet' : String(rec.grade);
  if(rec.grade === '' || rec.grade === null){
    resultRemarks.textContent = 'Study more, good luck in the Second Quarter! - Sir Jerson';
  } else {
    const g = Number(rec.grade);
    if(!isNaN(g) && g >= 75){
      resultRemarks.textContent = 'Congratulations! You passed the subject. Continue improving!';
    } else {
      resultRemarks.textContent = 'Study more, good luck in the Second Quarter! - Sir Jerson';
    }
  }
  show(result);
}

/* Logout */
logoutBtn.addEventListener('click', ()=>{
  if(confirm('Log out now?')){
    loggedIn = false;
    hide(portal);
    show(landing);
    hide(adminArea);
    hide(result);
    hide(lrnPrompt);
    currentSection = null;
  }
});

/* Admin toggle -> ask for passcode */
adminToggle.addEventListener('click', ()=>{
  const code = prompt('Enter admin passcode (teacher):');
  if(code === null) return;
  if(validAdminCode(code)){
    showAdmin();
  } else {
    alert('Incorrect admin passcode.');
  }
});

/* Show admin area and populate table */
function showAdmin(){
  show(adminArea);
  populateAdminTable();
}

/* populate admin table (sorted by section then name) */
function populateAdminTable(){
  dbBody.innerHTML = '';
  const ordered = DB.slice().sort((a,b)=>{
    if(a.section !== b.section) return a.section.localeCompare(b.section);
    return String(a.name||'').localeCompare(b.name||'');
  });
  ordered.forEach((rec, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="white-space:nowrap">${rec.section}</td>
      <td><input class="editable" data-idx="${idx}" data-field="lrn" value="${rec.lrn||''}" /></td>
      <td><input class="editable" data-idx="${idx}" data-field="name" value="${(rec.name||'')}" /></td>
      <td><input class="editable" data-idx="${idx}" data-field="grade" value="${rec.grade===undefined||rec.grade===null? '': rec.grade}" /></td>
      <td><button class="btn-ghost del-btn" data-idx="${idx}">Delete</button></td>
    `;
    dbBody.appendChild(tr);
  });

  // wire inputs
  dbBody.querySelectorAll('.editable').forEach(inp=>{
    inp.addEventListener('change', (e)=>{
      const i = parseInt(e.target.dataset.idx,10);
      const f = e.target.dataset.field;
      let v = e.target.value;
      if(f === 'grade'){
        v = v.trim() === '' ? '' : Number(v);
        if(v !== '' && (isNaN(v) || v < 0 || v > 100)){ alert('Grade must be 0–100 or blank.'); populateAdminTable(); return; }
      } else v = v.trim();
      // Update the DB: map ordered list's record back to DB by matching original unique combination (section + name + lrn)
      const orderedNow = DB.slice().sort((a,b)=>{
        if(a.section !== b.section) return a.section.localeCompare(b.section);
        return String(a.name||'').localeCompare(b.name||'');
      });
      const rec = orderedNow[i];
      if(!rec) return;
      // Note: to avoid ambiguous mapping when LRN or name changed, find by an index-based approach:
      // find first DB index whose section and original name/lrn match the rec's previous values
      // We'll locate by section and previous lrn (but previous lrn may have changed). Simpler: update the first DB entry that has same section and same name OR lrn.
      const ix = DB.findIndex(d => d.section === rec.section && (d.lrn === rec.lrn || d.name === rec.name));
      if(ix >= 0){
        DB[ix] = { section: rec.section, lrn: rec.lrn, name: rec.name, grade: rec.grade };
      } else {
        // fallback: replace by position in DB (best effort)
        DB[i] = { section: rec.section, lrn: rec.lrn, name: rec.name, grade: rec.grade };
      }
      // but we must actually set the updated field properly — recompute orderedNow and set:
      // Rebuild ordered list with updated values
      orderedNow[i][f] = v;
      // Now map orderedNow back to DB (by matching section + name + lrn if possible)
      // Simplest approach: replace DB with orderedNow (but keep other items too). We'll compute newDB as orderedNow + any DB items not in orderedNow (none missing)
      // For clarity here, just set DB = orderedNow concatenated with any remaining (empty)
      DB = orderedNow.concat(DB.filter(d=> !orderedNow.some(o => o.section===d.section && o.lrn===d.lrn && o.name===d.name)));
      // finally refresh table
      populateAdminTable();
    });
  });

  // wire delete buttons
  dbBody.querySelectorAll('.del-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const i = parseInt(e.target.dataset.idx,10);
      if(!confirm('Delete this record?')) return;
      const orderedNow = DB.slice().sort((a,b)=>{
        if(a.section !== b.section) return a.section.localeCompare(b.section);
        return String(a.name||'').localeCompare(b.name||'');
      });
      const rec = orderedNow[i];
      // find exact index in DB
      const ix = DB.findIndex(d => d.section === rec.section && d.lrn === rec.lrn && d.name === rec.name && String(d.grade) === String(rec.grade));
      if(ix >= 0){
        DB.splice(ix,1);
        populateAdminTable();
      } else {
        alert('Could not find record to delete.');
      }
    });
  });
}

/* Save DB to localStorage */
saveDbBtn.addEventListener('click', ()=>{
  if(!confirm('Save current database to browser storage?')) return;
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));
    alert('Database saved locally in browser storage.');
  }catch(e){ alert('Save failed: ' + e.message); }
});

/* Download CSV */
downloadCsv.addEventListener('click', ()=>{
  const headers = ['section','lrn','name','grade'];
  const rows = [headers.join(',')].concat(DB.map(r => {
    const lrn = `"${String(r.lrn||'').replace(/"/g,'""')}"`;
    const name = `"${String(r.name||'').replace(/"/g,'""')}"`;
    const grade = r.grade === '' || r.grade === null || r.grade === undefined ? '' : String(r.grade);
    return [r.section, lrn, name, grade].join(',');
  }));
  const csv = rows.join('\\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'gm_grades_backup.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* Upload CSV (replace DB) */
uploadCsvLabel.addEventListener('click', ()=> uploadCsv.click());
uploadCsv.addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    try{
      const parsed = parseCSV(String(evt.target.result || ''));
      if(parsed.length < 2) throw new Error('CSV appears empty or lacks rows.');
      const header = parsed[0].map(h => String(h||'').toLowerCase().trim());
      const si = header.indexOf('section'), li = header.indexOf('lrn'), ni = header.indexOf('name'), gi = header.indexOf('grade');
      if(si < 0 || li < 0 || ni < 0 || gi < 0) throw new Error('CSV must include headers: section, lrn, name, grade');
      const newDB = [];
      for(let i=1;i<parsed.length;i++){
        const row = parsed[i];
        if(!row || row.length < 4) continue;
        const section = String(row[si]||'').trim();
        const lrn = String(row[li]||'').replace(/^"|"$/g,'').trim();
        const name = String(row[ni]||'').replace(/^"|"$/g,'').trim();
        const gRaw = String(row[gi]||'').trim();
        const grade = gRaw === '' ? '' : Number(gRaw);
        newDB.push({section, lrn, name, grade});
      }
      if(!confirm('Replace current database with uploaded CSV?')) return;
      DB = newDB;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));
      populateAdminTable();
      alert('CSV imported, database replaced and saved locally.');
    }catch(err){ alert('CSV import failed: ' + err.message); }
  };
  reader.readAsText(file);
});

/* Basic CSV parser handling quoted fields */
function parseCSV(text){
  const lines = text.split(/\\r?\\n/).filter(l => l.trim() !== '');
  return lines.map(line => {
    const out = [];
    let cur = '';
    let inQuotes = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '\"'){
        if(inQuotes && line[i+1] === '\"'){ cur += '\"'; i++; continue; }
        inQuotes = !inQuotes; continue;
      }
      if(ch === ',' && !inQuotes){ out.push(cur); cur = ''; continue; }
      cur += ch;
    }
    out.push(cur);
    return out;
  });
}

/* On page load: nothing to show until login. But if adminArea visible from previous session, keep hidden. */
hide(portal);
hide(adminArea);
hide(result);
hide(lrnPrompt);

</script>
</body>
</html>
