<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dimasalang School Portal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f8ff;
            color: #333;
        }
        header {
            background-color: #1e90ff;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
        }
        .logo img {
            border-radius: 50%;
            margin-right: 15px;
        }
        .school-info h1 {
            margin: 0;
            font-size: 1.5em;
        }
        .school-info p {
            margin: 0;
            font-size: 0.9em;
        }
        main {
            padding: 20px;
        }
        .hidden { display: none; }
        button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #1e90ff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background-color: #4682b4; }
        input[type="text"], input[type="number"] {
            padding: 8px;
            margin: 5px 0;
            width: 100%;
            max-width: 300px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 8px;
            text-align: center;
        }
        .logout-btn { background-color: crimson; }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <a href="index.html">
                <img src="https://tinyurl.com/dnhslogosmall" alt="Dimasalang National High School Logo" width="60">
            </a>
        </div>
        <div class="school-info">
            <h1>Dimasalang National High School</h1>
            <p>Dimasalang, Masbate</p>
        </div>
    </header>

    <main id="app">
        <!-- The rest of your login and portal system code follows here -->
    </main>

    <script>
        /* Your existing JavaScript code for login, grade viewing, admin mode, etc. */
    </script>
</body>
</html>

    <section class="card center" id="landing">
      <h2 style="margin:0">Welcome! Please enter the code</h2>
      <div class="code-box">
        <input type="text" id="entry-code" placeholder="Enter your access code" autocomplete="off" />
        <div class="links">
          <button id="submit-code">Enter</button>
          <button id="clear-code" style="background:#ffffff;color:var(--text);border:1px solid rgba(11,37,69,0.06);">Clear</button>
        </div>
      </div>
      <p class="small" style="margin-top:10px">(Students: enter the code given by your teacher to access your class page.)</p>
    </section>

    <!-- General Mathematics interface -->
    <section class="card hidden" id="genmath">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <h2>Welcome to General Mathematics Grade Viewing Database</h2>
          <p class="small">Select your section below and then enter your LRN to view your grade.</p>
        </div>
        <div>
          <button class="logout" id="genmath-logout">Logout</button>
        </div>
      </div>
      <div class="nav" id="gen-sections">
        <button class="section-btn" data-section="Ember">Ember</button>
        <button class="section-btn" data-section="Oasis">Oasis</button>
        <button class="section-btn" data-section="Solstice">Solstice</button>
        <button class="section-btn" data-section="Meadow">Meadow</button>
      </div>

      <div id="gen-section-area" style="margin-top:18px"></div>
    </section>

    <!-- TatakSTEM interface -->
    <section class="card hidden" id="tatak">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <h2>Welcome to Grade-11 Aurora (STEM) Database</h2>
          <p class="small">Science, Technology, Engineering, and Mathematics Class Batch 2025 - 2026</p>
        </div>
        <div>
          <button class="logout" id="tatak-logout">Logout</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <label class="small">Enter your Learner's Reference Number (LRN)</label><br/>
        <input type="text" id="tatak-lrn" placeholder="Enter LRN" autocomplete="off" />
        <div style="margin-top:8px"><button id="tatak-view">View Grades</button></div>
      </div>

      <div id="tatak-result" style="margin-top:18px"></div>
    </section>

    <section class="card hidden" id="admin-panel">
      <h3>ADMIN MODE — Master Spreadsheet</h3>
      <p class="small">(PIN required to enter admin mode)</p>
      <div id="admin-auth">
        <input type="password" id="admin-pin" placeholder="Enter admin pin" />
        <button id="admin-enter">Enter Admin</button>
      </div>
      <div id="admin-area" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="admin-tools">
            <button id="export-csv" class="csv-export">Export CSV</button>
            <button id="import-csv" class="csv-export">Import CSV</button>
            <input type="file" id="file-input" accept=".csv" style="display:none" />
            <button id="save-db" class="csv-export">Save Database</button>
          </div>
          <div>
            <button id="exit-admin" style="background:#fff;color:var(--text);border:1px solid rgba(11,37,69,0.06);">Exit Admin</button>
          </div>
        </div>

        <div style="margin-top:12px;overflow:auto;max-height:520px">
          <table id="master-table">
            <thead id="master-head"></thead>
            <tbody id="master-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="small">Congratulations! You survived the First Quarter of School Year 2025-2026 — Sir Jerson</footer>
  </div>

  <script>
    /********************* Data setup **************************/
    // General Math sections' students: embed as objects
    const genData = {
      Ember: [
        ["113597140014","AFABLE,CLARENS ANTIPOLO",74],
        ["113610140002","ALFORTE,RANNEL JOHN BALDEO",78],
        ["113606140068","ATABAY,JURODS BASAS",75],
        ["113606140041","CAGATIN,MARC JAY MARFIL",74],
        ["113606140051","CAPELLAN,JAMES ROLLY TOLENTINO",77],
        ["113606140046","CASTOR,KENNY RICH SALONDAGA",82],
        ["120868140083","GERVACIO,CZECH NAZARINE DINGAL",80],
        ["113951140024","GIMANG,BABY NIÑO VAFLOR",94],
        ["113943140021","GUIOGUIO,WINNARD KENT DALANON",88],
        ["113604140035","LETADA,R-JAY VILLAMOR",75],
        ["113712140015","TAMAYO,RENZ IVAN FUENTES",75],
        ["113606140183","VILLAMIN,JAMES JAHRED GUIRIBA",84],
        ["113606140185","VISDA,MATTHEW JOSH BISNAR",78],
        ["113606140113","ABAÑO,JESSA MAE ALICANTE",75],
        ["113612120033","AFABLE,NOVIE EMPAS",78],
        ["113951140037","ALORAN,MARIA PRINCESS AMARO",79],
        ["113606140124","ARROYO,KIMBERLY MOTITA",79],
        ["113606140126","ATABAY,JEAN ESCARO",86],
        ["113606140128","ATABAY,MARY CLAIRE GADIANA",84],
        ["113606150115","CAJEGAS,BENNIE MARIE CAPELLAN",81],
        ["136836140494","CAPELLAN,PRESCILLA ENATE",80],
        ["113606150071","CARILLO,IRISH MITRA",81],
        ["113610140012","CLORES,JOJIELYN ARAGON",82],
        ["113786140045","DELAVIN,CHENKIE CASIO",83],
        ["113606140144","DERLA,PRINCESS MAE SORIANO",85],
        ["103871140036","ESCALA,SCARLETTE SORIANO",88],
        ["113605140032","GARCIA,ANALYN TAMAYO",90],
        ["113610140016","LOZADA,NECEL JOY BULALAQUE",91],
        ["113604140052","NAGA,JAMIE LOREN TINAY",85],
        ["113606140164","ORIAS,TRISHA JANE NUÑEZ",81],
        ["113603140010","PABILANDO,JHOANNA VILLANTES",89],
        ["113606140160","PEÑARANDA,JAN MONICQUE ESPARRAGO",88],
        ["113606140178","ROBISO,ANDREA ATENDIDO",75],
        ["113605140039","SANCHEZ,DIANNE PATRICIA BERGADO",93],
        ["113504140033","TORRENUEVA,PRINCESS GEMINO",85],
        ["113606140161","VALLERAS,ROSELYN JERUSALEM",79]
      ],
      Oasis: [
        ["113606140050","Arimbuyutan, Nhel John Elyson A.",76],
        ["113602140005","Belarmino, Mark Dm H.",83],
        ["113606140060","Canete, Jolit Z.",78],
        ["113597140071","Diaz, Jethro L.",90],
        ["113613140004","Ecita, Lorince D.",76],
        ["113613140005","Igloso, Jerry Jr. C.",80],
        ["113617140031","Mahayag, Kyle",85],
        ["113604140036","Mahinay, Romel C.",81],
        ["113606140074","Manlangit, Lester C.",88],
        ["113615140011","Minggoy, John Mark V.",75],
        ["113605130037","Ramirez, Jielo A.",77],
        ["113604140042","Serafin, Reynald P.",70],
        ["136838140101","Ubac, Michael John M.",79],
        ["113606150124","Alforque, Anniver C.",75],
        ["113615140014","Aplacador, Arnie",77],
        ["113614140016","Apues, Marjorie A.",75],
        ["113606140129","Arizobal, Jenny P.",75],
        ["113606140088","Atizado, Princess Odesa P.",81],
        ["113951140053","Bandol, Loida A.",77],
        ["110282140176","Baring, Kristine M.",81],
        ["113599140015","Baring, Lanilyn A.",90],
        ["113606140143","Bayagosa, Esiel V.",76],
        ["113606140139","Caones, Cynde M.",82],
        ["113597140019","Catarinin, Victoria M.",81],
        ["113612140024","Etang, Kristine Rein Lara",80],
        ["113617140002","Francisco, Emmalyn E.",81],
        ["113613140019","Jubay, Jeann M.",74],
        ["123456789012","Lerit, Sassy Liane A.",70],
        ["113597140053","Luzong C. Nancy",86],
        ["113786140055","Mahinay, Gella",77],
        ["113597120160","Moreno, Jenny A.",75],
        ["113606140177","Natural, Erika Joy P.",79],
        ["113606140114","Noda, Glyza B.",75],
        ["113604140050","Orbes, Annjean B.",78],
        ["113613140016","Paghunasan, Shery-Ann T.",83],
        ["113606140115","Paran, Ronalyn D.",81],
        ["113951140046","Pascua, Danica A.",78],
        ["113951140086","Presilda, Janna Shane R.",78],
        ["113606140116","Ramirez, Jendy V.",80],
        ["113597140027","Rupa, Clavel O.",78]
      ],
      Solstice: [
        ["113612140003","AVILA,GIAN JOSH RAYMUNDO",76],
        ["113605130028","BELEN,JACKPHILLIP MENDERO",73],
        ["110108140048","BERRES,GEIAN CARLO RONDA",75],
        ["136524150592","CABRALES,AL FRANCIS AFABLE",78],
        ["113606140044","CARMEN,ERNESTO JR BERDIN",73],
        ["113606130133","COSTE,IGNACIO III ABAYON",73],
        ["113606110055","DEL MUNDO,JUSTINE PABATANG",74],
        ["109156150106","DELA CRUZ,JOHN KYLE -",76],
        ["113602130016","DOCUSIN,GIAN SOCITO",78],
        ["113954130030","ERENIA,KIM OCHEA",73],
        ["113597140011","FLORES,DAVE RABUYA",75],
        ["113604120065","LIBAY,JOSHUA VILLAMAR",77],
        ["113602140012","LUCENESIO,MARK JUSTIN ETAOC",73],
        ["113613130008","LUGANA,JADE IGLOSO",70],
        ["113606140099","LUZONG,BRENT KEVIN ARIZOBAL",80],
        ["113608110042","MALANA,GEHARD ADIGUE",81],
        ["113614140009","MONTECALVO,JOJIE AREGLADO",75],
        ["113612140020","TAMAYO,JOHN LESTER BELARMINO",75],
        ["104753140051","TOROY,DAVE ESPEJON",76],
        ["136477140516","TRINIDAD,JOHN WAYNE LUTCHE",73],
        ["113603140006","TUMANGAN,NHOAH BUJAWE",75],
        ["113606140119","ALIÑO,JEAN BENARO",73],
        ["113597140076","ARCUENO,AMANDA ANDRINO",84],
        ["113606140123","ARMA,ROCHELLE COSTE",74],
        ["113612140023","BARRUGA,RICHEL SOQUESO",73],
        ["113613140012","BRUSAS,JESSEL CAPALAR",81],
        ["113608120068","CANTORIA,JIZEL AMARO",73],
        ["113613140013","CAPALAR,RICHELYN CABAIS",80],
        ["113602140021","CARASICAS,SUSAN ANABE",74],
        ["113606140093","COLIBAO,ALEYAH ARCUENO",76],
        ["113610140013","ESCOTE,ROMA MAE MONCADA",73],
        ["113604140046","FRANCISCO,ANIELYN PALANAS",76],
        ["113605140033","GARCIA,SHIELA MAE BARILE",74],
        ["113606140150","GESTIADA,JULIA JANE IGNACIO",75],
        ["113606130227","MADERA,JERECA VERDIDA",73],
        ["113951130094","RICARTE,SHEILA MAE ESQUILONA",75],
        ["113612140027","ROMBAIZ,ROSALYN ADIGUE",73],
        ["113617140028","SALUNDAGA,JOSEL ALMOGUERA",75],
        ["113597140065","SANCHEZ,JESEL ARCUENO",73],
        ["113612140028","TAMAYO,PRINCESS HANNAH YLARAN",75]
      ],
      Meadow: [
        ["113610130009","ARRANGUEZ,MARK LEO ALFORTE",73],
        ["113956130022","BOGABIL,ALDIN LUMALANG",76],
        ["113602140017","CABAGUE,MIGUEL VIDA",75],
        ["113604140006","CABINTOY,JEROME CASIDSID",73],
        ["113602120010","CARASICAS,JEVAN ANABE",76],
        ["113605140007","DELA CRUZ,JHONNY FRANCISCO",75],
        ["113604140007","FLORES,JEM VASQUEZ",77],
        ["113605140012","MANANGAT,ERIC MENEL",76],
        ["113604140038","MITRA,CYRIL JOHN ESTRADA",73],
        ["113610140006","MONCADA,RON MART ESCOTE",76],
        ["113606140169","PARAGUYA,GERALD ESCARAN",74],
        ["113605140017","PINOTE,JAMES ABLAS",76],
        ["113606140181","RAMIREZ,RONIE MARK MENDOZA",75],
        ["113606140182","TANA,FRANCE HERMOSA",73],
        ["113613130013","URBANO,JOHN CARLO CAPELLAN",90],
        ["113612110001","ABAD,JUVYMAE BARRUGA",null],
        ["113610140008","ADORNA,CHARISA REBUJAS",75],
        ["113610140009","ALFORTE,MERYL JOY CAÑELAS",75],
        ["113597130044","ARCUENO,JENELYN PRESILDA",73],
        ["113605140023","ATIBAGOS,CRISHELLE FLORES",74],
        ["113610140010","BADIANA,MARIAN ARCON",73],
        ["113613130017","BILARMINO,RAYCEL LATAGAN",74],
        ["113610140011","BOGNOT,KIMBERLY ARAGON",73],
        ["113596120049","CAADLAWON,BELIZA BOHOL",75],
        ["113604140012","CARIÑO,DANICE ARQUIO",75],
        ["113606140147","CLEMENTE,MAURENE NICDAO",77],
        ["165510141544","COLLADO,HANNAH OSABEL",72],
        ["120741140026","CONTREDAS,CRISTINE LABATETE",74],
        ["113606140094","COSTE,GECEL TABOR",74],
        ["113608140014","CUIZON,JUNALYN ABELINDE",75],
        ["113942140018","DAO,LEIAN CARILLO",75],
        ["113612130037","DELA PEÑA,CHARLENE GAVIOLA",77],
        ["113606140096","DELOS SANTOS,LUJIL BELO",75],
        ["113597140021","ECITA,CHARMAE CAÑELAS",77],
        ["113597140077","LUCENESIO,ANGELICA VEPINOSA",76],
        ["113606140175","MAGLASANG,DANIELA COLUMNA",81],
        ["113617130046","MATERDAN,JESALYN TAMBOBOY",72],
        ["113606140118","RAYMUNDO,RHEA BANDOL",76],
        ["113605140038","SAMPAGA,JESSICA VILLAR",74]
      ]
    };

    // TatakSTEM master list (32 students) with two provided subjects: Media & Info Lit and Intro to Philo.
    const tatakStudents = [
      {lrn:'113797140007',name:'Alutaya, MJ O.'},
      {lrn:'113604140025',name:'Aparente, Austin Jolf S.'},
      {lrn:'113604140026',name:'Arizobal, Robert Jules O.'},
      {lrn:'113606150076',name:'Atacador, Rey Kenneth C.'},
      {lrn:'113606130113',name:'Capellan, Kian Carl N.'},
      {lrn:'113602140018',name:'Delara, Jhonpyu A.'},
      {lrn:'113602140008',name:'Delara, Joeren Joules O.'},
      {lrn:'113606150001',name:'Dilao, Mark Lawrence P.'},
      {lrn:'113606140061',name:'Gabelo, Yeshuah Ashliegh B.'},
      {lrn:'113606150116',name:'Gamba, Renzell Wen G.'},
      {lrn:'113951140031',name:'Manlapaz, Mark Laurence B.'},
      {lrn:'113606140170',name:'Paraguya, Josua E.'},
      {lrn:'113605140018',name:'Piodos, John Errol M.'},
      {lrn:'113612140017',name:'Raymundo, Kyle Nathan M.'},
      {lrn:'113597140007',name:'Resma, Lenard B.'},
      {lrn:'113599140008',name:'Retuerto, Remark Fel R.'},
      {lrn:'113606140109',name:'Valle, Jahn Aj Vhin T.'},
      {lrn:'113606140130',name:'Almero, Mikaela Mildred D.'},
      {lrn:'113606140132',name:'Arizala, Rain A.'},
      {lrn:'113786140015',name:'Atega, Dianne Ashly M.'},
      {lrn:'113608140025',name:'Cabrera, Wenchie P.'},
      {lrn:'113606140142',name:'Cervantes, Nica A.'},
      {lrn:'113589140014',name:'Edem, Jeramie M.'},
      {lrn:'113606140173',name:'Huelva, Jelianne S.'},
      {lrn:'113597140060',name:'Ibañez, Carmela O.'},
      {lrn:'113597140060',name:'Jores, Cristel B.'},
      {lrn:'113597140026',name:'Malunes, Fricel Blaze A.'},
      {lrn:'113599140030',name:'Pelayo, Trecia Faith C.'},
      {lrn:'402104150245',name:'Peteros, Lhola Belle E.'},
      {lrn:'113677130163',name:'Salazar, Shane A.'},
      {lrn:'113609140024',name:'Tagbacaola, Irene A.'},
      {lrn:'113782140023',name:'Tamayo, Mary Antoniette A.'}
    ];

    // Provided grades arrays (order corresponds to tatakStudents order)
    const mediaInfoGrades = [96,91,92,96,89,93,95,91,94,90,91,91,97,92,92,96,91,91,92,86,92,96,89,97,93,94,92,84,97,97,92,94];
    const philoGrades = [91,84,86,88,85,87,82,87,85,85,85,82,90,84,85,88,84,79,88,84,88,87,79,89,86,89,91,85,88,89,93,93];

    const tatakSubjects = [
      'Earth Science','General Mathematics','Oral Communication in Context','21st Century Literature from the Philippines and the World','Introduction to Philosophy of the Human Person','Komunikasyon at Pananaliksik sa Wika at Kulturang Pilipino','Media and Information Literacy','Physical Education and Health','Pre – Calculus'
    ];

    // Build tatak student database where only Media & Info Lit (index 6) and Intro to Philo (index 4) have values; others blank
    const tatakDB = tatakStudents.map((s,i)=>{
      const grades = Array(tatakSubjects.length).fill(null);
      grades[6] = mediaInfoGrades[i];
      grades[4] = philoGrades[i];
      return {lrn:s.lrn,name:s.name,grades:grades};
    });

    /********************* Utilities **************************/
    function show(el){el.classList.remove('hidden')}
    function hide(el){el.classList.add('hidden')}

    // Easy storage: keep an editable DB in localStorage; initialize if empty
    function saveDB(){
      localStorage.setItem('genData',JSON.stringify(genData));
      localStorage.setItem('tatakDB',JSON.stringify(tatakDB));
      alert('Database saved locally (browser storage).');
    }
    function loadDB(){
      try{
        const gd = JSON.parse(localStorage.getItem('genData'));
        const td = JSON.parse(localStorage.getItem('tatakDB'));
        if(gd) Object.assign(genData,gd);
        if(td) {
          // replace tatakDB contents
          for(let i=0;i<td.length;i++) tatakDB[i]=td[i];
        }
      }catch(e){console.warn('no db yet')}
    }
    loadDB();

    /********************* Landing code handling **********************/
    document.getElementById('submit-code').addEventListener('click',handleCode);
    document.getElementById('entry-code').addEventListener('keyup',e=>{if(e.key==='Enter')handleCode()});
    document.getElementById('clear-code').addEventListener('click',()=>{document.getElementById('entry-code').value=''});

    function handleCode(){
      const code = document.getElementById('entry-code').value.trim();
      if(!code) return alert('Please enter an access code.');
      // don't reveal codes on page; match silently
      if(code === 'GenMath2025'){
        hide(document.getElementById('landing'));
        show(document.getElementById('genmath'));
        hide(document.getElementById('tatak'));
        hide(document.getElementById('admin-panel'));
      } else if(code === 'TatakSTEM'){
        hide(document.getElementById('landing'));
        show(document.getElementById('tatak'));
        hide(document.getElementById('genmath'));
        hide(document.getElementById('admin-panel'));
      } else {
        alert('Invalid code. Please check with your teacher.');
      }
      document.getElementById('entry-code').value='';
    }

    // logout buttons
    document.getElementById('genmath-logout').addEventListener('click',()=>{hide(document.getElementById('genmath'));show(document.getElementById('landing'));});
    document.getElementById('tatak-logout').addEventListener('click',()=>{hide(document.getElementById('tatak'));show(document.getElementById('landing'));});

    /********************* General Math interactions ********************/
    const genSectionArea = document.getElementById('gen-section-area');
    document.querySelectorAll('#gen-sections .section-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const sec = btn.dataset.section;
        renderGenSection(sec);
      })
    });

    function renderGenSection(section){
      genSectionArea.innerHTML = '';
      const box = document.createElement('div');
      box.className='card';
      box.innerHTML = `
        <h3>Section: ${section}</h3>
        <p class="small">Enter your LRN to view your General Mathematics grade.</p>
        <input type="text" id="gen-lrn" placeholder="Enter your LRN" />
        <div style="margin-top:8px"><button id="gen-view">View Grade</button></div>
        <div id="gen-result" style="margin-top:12px"></div>
      `;
      genSectionArea.appendChild(box);

      document.getElementById('gen-view').addEventListener('click',()=>{
        const l = document.getElementById('gen-lrn').value.trim();
        viewGenGrade(section,l);
      });
      document.getElementById('gen-lrn').addEventListener('keyup',e=>{if(e.key==='Enter')document.getElementById('gen-view').click()});
    }

    function viewGenGrade(section,lrn){
      const result = document.getElementById('gen-result');
      result.innerHTML='';
      if(!lrn) return alert('Please enter your LRN.');
      // search in genData[section]
      const arr = genData[section]||[];
      const found = arr.find(r=>String(r[0])===String(lrn));
      if(!found){ result.innerHTML="<p class='small'>LRN not found in this section. Please check your LRN or section.</p>"; return }
      const name = found[1];
      const grade = found[2];
      const pass = grade>=75;
      result.innerHTML = `
        <div class="info">
          <strong>${name}</strong><div class="small">LRN: ${found[0]}</div>
          <hr />
          <div style="margin-top:8px"><strong>General Mathematics:</strong> ${grade===null? 'No grade yet' : grade}</div>
          <div style="margin-top:8px;font-weight:600">${grade!==null ? (pass ? 'Congratulations! You passed the subject. Continue improving!' : 'May second quarter pa, pwedeng-pwede pang bumawi!') : ''}</div>
        </div>
      `;
      // Add logout and return buttons
      const btns = document.createElement('div'); btns.style.marginTop='10px';
      const logout = document.createElement('button'); logout.textContent='Logout'; logout.className='logout'; logout.onclick=()=>{hide(document.getElementById('genmath')); show(document.getElementById('landing'))};
      btns.appendChild(logout);
      result.appendChild(btns);
    }

    /********************* TatakSTEM interactions ************************/
    document.getElementById('tatak-view').addEventListener('click',()=>{
      const l = document.getElementById('tatak-lrn').value.trim();
      viewTatak(l);
    });
    document.getElementById('tatak-lrn').addEventListener('keyup',e=>{if(e.key==='Enter')document.getElementById('tatak-view').click()});

    function viewTatak(lrn){
      const out = document.getElementById('tatak-result'); out.innerHTML='';
      if(!lrn) return alert('Please enter your LRN.');
      const student = tatakDB.find(s=>String(s.lrn)===String(lrn));
      if(!student) { out.innerHTML = '<p class="small">LRN not found. Please check your LRN.</p>'; return }
      // Show student details and table of subjects
      const container = document.createElement('div'); container.className='student-view';
      const left = document.createElement('div'); left.className='info';
      left.innerHTML = `<strong>${student.name}</strong><div class='small'>LRN: ${student.lrn}</div><hr/>`;
      // list subjects
      const tbl = document.createElement('table');
      const thead = document.createElement('thead'); thead.innerHTML='<tr><th>Subject</th><th>Grade</th></tr>';
      const tbody = document.createElement('tbody');
      student.grades.forEach((g,i)=>{
        const tr = document.createElement('tr');
        const sub = document.createElement('td'); sub.textContent = tatakSubjects[i];
        const gd = document.createElement('td'); gd.textContent = g===null? '---' : g;
        tr.appendChild(sub); tr.appendChild(gd); tbody.appendChild(tr);
      });
      tbl.appendChild(thead); tbl.appendChild(tbody);
      left.appendChild(tbl);

      // compute final average from available grades
      const numeric = student.grades.filter(x=>x!==null && !isNaN(x));
      const avg = numeric.length? (numeric.reduce((a,b)=>a+b,0)/numeric.length) : null;
      const right = document.createElement('div'); right.className='info';
      right.innerHTML = `<div style='font-size:15px;font-weight:700'>Final Average</div>
        <div style='font-size:24px;margin-top:6px'>${avg===null? 'No grades yet' : avg.toFixed(2)}</div>
        <div class='small' style='margin-top:8px'>${avg!==null? honorsText(avg): ''}</div>
      `;

      container.appendChild(left); container.appendChild(right);
      out.appendChild(container);

      // message & teacher note
      const note = document.createElement('div'); note.style.marginTop='12px'; note.innerHTML=`<em>"Science, Technology, Engineering, and Mathematics Class Batch 2025 - 2026"</em>`;
      out.appendChild(note);

      const congrats = document.createElement('div'); congrats.style.marginTop='12px'; congrats.innerHTML = `<div style='font-family:Georgia, serif;font-size:18px;font-weight:600'>Congratulations! You survived the First Quarter of School Year 2025-2026 — Sir Jerson</div>`;
      out.appendChild(congrats);

      // add logout
      const lbtn = document.createElement('button'); lbtn.textContent='Logout'; lbtn.className='logout'; lbtn.style.marginTop='10px'; lbtn.onclick=()=>{hide(document.getElementById('tatak')); show(document.getElementById('landing'))};
      out.appendChild(lbtn);
    }

    function honorsText(avg){
      // Honor boundaries provided
      if(avg>=97.555555555 && avg<=100) return 'WITH HIGHEST HONORS';
      if(avg>=94.5555555555 && avg<=97.4444444444) return 'WITH HIGH HONORS';
      if(avg>=89.544444 && avg<=94.4444444444) return 'WITH HONORS';
      return '';
    }

    /********************* Admin Mode ******************************/
    const adminToggle = document.getElementById('admin-toggle');
    adminToggle.addEventListener('click',()=>{
      // open admin area (requires pin)
      hide(document.getElementById('landing'));
      hide(document.getElementById('genmath'));
      hide(document.getElementById('tatak'));
      show(document.getElementById('admin-panel'));
    });

    document.getElementById('admin-enter').addEventListener('click',()=>{
      const pin = document.getElementById('admin-pin').value.trim();
      if(pin === '675915'){
        document.getElementById('admin-auth').classList.add('hidden');
        document.getElementById('admin-area').classList.remove('hidden');
        populateMasterTable();
      } else alert('Incorrect admin pin.');
    });

    document.getElementById('exit-admin').addEventListener('click',()=>{
      document.getElementById('admin-auth').classList.remove('hidden');
      document.getElementById('admin-area').classList.add('hidden');
      // return to landing
      hide(document.getElementById('admin-panel'));
      show(document.getElementById('landing'));
    });

    // Build a combined master table containing both GenMath and Tatak student entries
    function getMasterRows(){
      // We'll create rows for tatak first (32) and then gen sections as separate rows (section name included)
      const rows = [];
      // tatak: LRN, name, subjects...
      tatakDB.forEach(s=>{
        const row = {type:'tatak',lrn:s.lrn,name:s.name,grades:s.grades};
        rows.push(row);
      });
      // genData: create rows for each student with one subject "General Mathematics"
      for(const sec of Object.keys(genData)){
        genData[sec].forEach(r=>{
          const row = {type:'gen',section:sec,lrn:r[0],name:r[1],grades:[r[2]]};
          rows.push(row);
        });
      }
      return rows;
    }

    function populateMasterTable(){
      const head = document.getElementById('master-head');
      const body = document.getElementById('master-body');
      head.innerHTML = '';
      body.innerHTML = '';

      // Build headers: type, lrn, name, then subjects for tatak, and GenMath (single col) for gen rows
      const trh = document.createElement('tr');
      trh.innerHTML = '<th>Type</th><th>LRN</th><th>Name</th>' + tatakSubjects.map(s=>`<th>${s}</th>`).join('') + '<th>GenMath</th><th>Actions</th>';
      head.appendChild(trh);

      const rows = getMasterRows();
      rows.forEach((r,idx)=>{
        const tr = document.createElement('tr');
        const typeTd = document.createElement('td'); typeTd.textContent = r.type;
        const lrnTd = document.createElement('td'); lrnTd.textContent = r.lrn;
        const nameTd = document.createElement('td'); nameTd.textContent = r.name;
        tr.appendChild(typeTd); tr.appendChild(lrnTd); tr.appendChild(nameTd);
        // tatakSubjects columns
        for(let i=0;i<tatakSubjects.length;i++){
          const td = document.createElement('td');
          let val = null;
          if(r.type==='tatak') val = r.grades[i]===null? '': r.grades[i];
          // if gen row, and i corresponds to General Mathematics index (1) we don't fill; we will put gen into last GenMath column
          const inp = document.createElement('input'); inp.style.width='60px'; inp.value = val===null? '': val; inp.dataset.ridx = idx; inp.dataset.sub = i; inp.dataset.type = r.type; inp.addEventListener('change',onMasterEdit);
          td.appendChild(inp); tr.appendChild(td);
        }
        // GenMath column
        const genTd = document.createElement('td');
        const genInp = document.createElement('input'); genInp.style.width='60px';
        if(r.type==='gen') genInp.value = r.grades[0]===null? '': r.grades[0];
        genInp.dataset.ridx = idx; genInp.dataset.sub = 'gen'; genInp.dataset.type = r.type; genInp.addEventListener('change',onMasterEdit);
        genTd.appendChild(genInp); tr.appendChild(genTd);

        const actions = document.createElement('td');
        const del = document.createElement('button'); del.textContent='Delete'; del.style.padding='6px'; del.onclick=()=>{if(confirm('Delete this row?')){deleteRow(r); populateMasterTable();}};
        actions.appendChild(del);
        tr.appendChild(actions);

        body.appendChild(tr);
      });
    }

    function onMasterEdit(e){
      const input = e.target; const ridx = Number(input.dataset.ridx); const type = input.dataset.type; const sub = input.dataset.sub; const val = input.value.trim();
      // Update underlying data structures
      const rows = getMasterRows(); const row = rows[ridx];
      if(!row) return;
      if(row.type==='tatak'){
        // find index of student in tatakDB by lrn
        const sidx = tatakDB.findIndex(s=>s.lrn===row.lrn);
        if(sidx>=0 && sub!=='gen'){
          tatakDB[sidx].grades[sub]= val===''? null: Number(val);
        }
      } else if(row.type==='gen'){
        // find in genData by section and lrn
        const secArr = genData[row.section];
        const sidx = secArr.findIndex(r=>String(r[0])===String(row.lrn));
        if(sidx>=0 && sub==='gen'){
          secArr[sidx][2] = val===''? null: Number(val);
        }
      }
      // Keep changes in localStorage for persistence
      saveDB();
    }

    function deleteRow(row){
      if(row.type==='tatak'){
        const idx = tatakDB.findIndex(s=>s.lrn===row.lrn); if(idx>=0) tatakDB.splice(idx,1);
      } else if(row.type==='gen'){
        const secArr = genData[row.section]; const idx = secArr.findIndex(r=>String(r[0])===String(row.lrn)); if(idx>=0) secArr.splice(idx,1);
      }
      saveDB();
    }

    document.getElementById('export-csv').addEventListener('click',()=>{
      const rows = getMasterRows();
      // headers
      const headers = ['type','lrn','name',...tatakSubjects,'GenMath'];
      const csv = [headers.join(',')];
      rows.forEach(r=>{
        const rowArr = [];
        rowArr.push(r.type); rowArr.push(`"${r.lrn}"`); rowArr.push(`"${r.name}"`);
        if(r.type==='tatak'){
          r.grades.forEach(g=>rowArr.push(g===null? '': g));
          rowArr.push(''); // gen math empty
        } else {
          // tatak cols empty
          for(let i=0;i<tatakSubjects.length;i++) rowArr.push('');
          rowArr.push(r.grades[0]===null? '': r.grades[0]);
        }
        csv.push(rowArr.join(','));
      });
      const blob = new Blob([csv.join('\n')],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = 'master_database.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('import-csv').addEventListener('click',()=>{document.getElementById('file-input').click()});
    document.getElementById('file-input').addEventListener('change',(e)=>{
      const f = e.target.files[0]; if(!f) return; const reader = new FileReader();
      reader.onload = function(){
        const text = reader.result; parseImportedCSV(text);
      };
      reader.readAsText(f);
    });

    function parseImportedCSV(text){
      const lines = text.split(/\r?\n/).filter(l=>l.trim());
      if(lines.length<2) return alert('CSV seems empty');
      const headers = lines[0].split(',');
      const data = lines.slice(1).map(l=>l.split(','));
      // Clear existing and rebuild
      // We'll replace tatakDB and genData entries where possible
      // For simplicity: create new arrays
      const newTatak = [];
      const newGen = {Ember:[],Oasis:[],Solstice:[],Meadow:[]};
      data.forEach(cols=>{
        const type = cols[0]; const lrn = cols[1].replace(/"/g,''); const name = (cols[2]||'').replace(/"/g,'');
        if(type==='tatak'){
          const grades = [];
          for(let i=0;i<tatakSubjects.length;i++) grades.push(cols[3+i]===''? null: Number(cols[3+i]));
          newTatak.push({lrn,name,grades});
        } else if(type==='gen'){
          // gen students will have gen math in last column
          const gm = cols[3+tatakSubjects.length];
          // user must supply section in name? Not available — we'll append to Ember by default
          newGen.Ember.push([lrn,name, gm===''? null: Number(gm)]);
        }
      });
      if(newTatak.length) {tatakDB.length=0; newTatak.forEach(x=>tatakDB.push(x))}
      // For gen, merge
      if(newGen.Ember.length) genData.Ember = newGen.Ember;
      saveDB();
      populateMasterTable();
      alert('CSV imported to local database');
    }

    document.getElementById('save-db').addEventListener('click',()=>{saveDB(); populateMasterTable();});

    // Initialize admin table on load if admin already authenticated (unlikely)
    // provide quick load when admin panel displayed

    // On page load, hide panels accordingly
    hide(document.getElementById('genmath'));
    hide(document.getElementById('tatak'));
    hide(document.getElementById('admin-panel'));

    // allow deep link: if user pastes code directly in URL as ?code=GenMath2025
    (function(){
      const params = new URLSearchParams(location.search); const c = params.get('code'); if(c){document.getElementById('entry-code').value=c; handleCode()}
    })();

    // Save DB automatically before unload
    window.addEventListener('beforeunload',()=>{try{saveDB()}catch(e){}});

  </script>
</body>
</html>


